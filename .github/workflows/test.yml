name: Test Builds

on:
 push:
  branches:
  - main
  paths-ignore:
    - '.github/**'
    - '.vscode/**'
    - '.gitignore'
    - '.gitattributes'
    - '*.md'
    - 'LICENSE'
    - 'README*'
    - 'CHANGELOG*'
    - 'docs/**'

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

env:
  PROJECT_PATH: forest-survival-multiplayer

jobs:
 Detect-Platforms:
  runs-on: ubuntu-latest
  outputs:
      matrix: ${{ steps.detect.outputs.matrix }}
      has-platforms: ${{ steps.detect.outputs.has-platforms }}
      godot-version: ${{ steps.detect.outputs.godot-version }}
      game-name: ${{ steps.detect.outputs.game-name }}
      project-path: ${{ steps.detect.outputs.project-path }}
  steps:
  - uses: actions/checkout@v4
  
  - name: Detect Project + Export Presets
    id: detect
    uses: ./.github/actions/detect-godot-config
    with:
      project-path-default: ${{ env.PROJECT_PATH }}

 Test-Export:
  needs: Detect-Platforms
  if: needs.Detect-Platforms.outputs.has-platforms == 'true'
  runs-on: ubuntu-latest
  strategy:
    matrix: ${{ fromJson(needs.Detect-Platforms.outputs.matrix) }}
    fail-fast: false
  steps:
  - uses: actions/checkout@v4
  
  - name: Setup Godot
    uses: ./.github/actions/godot-setup
    with:
      godot-version: ${{ needs.Detect-Platforms.outputs.godot-version }}

  - name: Test Export ${{ matrix.platform }}
    uses: ./.github/actions/godot-export
    with:
      project-path: ${{ needs.Detect-Platforms.outputs.project-path }}
      preset: ${{ matrix.preset }}
      export-dir: exports/${{ matrix.folder }}
      export-file: ${{ matrix.file }}
      platform: ${{ matrix.platform }}
  
  - name: Upload ${{ matrix.platform }} Test Build
    uses: actions/upload-artifact@v4
    with:
     name: export-${{ matrix.platform }}
     path: exports/${{ matrix.folder }}
     retention-days: 30  # Kept for 30 days so releases can reuse them

 Preview-Release:
  needs: [Detect-Platforms, Test-Export]
  if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for changelog
    
    - name: Generate Preview Release Notes
      id: preview
      uses: mathieudutour/github-tag-action@v6.2
      with:
       github_token: ${{ secrets.GITHUB_TOKEN }}
       dry_run: true  # Don't actually create tag, just preview
       default_bump: false
       release_branches: main
    
    - name: Show Preview Release Info
      shell: bash
      run: |
        echo "## ðŸ“¦ Release Preview" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "If you trigger a release now, this is what will be created:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "${{ steps.preview.outputs.new_tag }}" ]; then
          echo "### ðŸ·ï¸ Version Tag" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ steps.preview.outputs.new_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Changelog" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.preview.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Platforms Ready" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… All exports tested successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "To create this release, go to:" >> $GITHUB_STEP_SUMMARY
          echo "**Actions** â†’ **Release to GitHub & Itch.io** â†’ **Run workflow**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **No version bump detected**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Make sure your commit messages follow conventional commits:" >> $GITHUB_STEP_SUMMARY
          echo "- \`feat:\` for new features (minor version bump)" >> $GITHUB_STEP_SUMMARY
          echo "- \`fix:\` for bug fixes (patch version bump)" >> $GITHUB_STEP_SUMMARY
          echo "- \`BREAKING CHANGE:\` for breaking changes (major version bump)" >> $GITHUB_STEP_SUMMARY
        fi

 Test-Summary:
  needs: [Detect-Platforms, Test-Export]
  if: always()
  runs-on: ubuntu-latest
  steps:
    - name: Test Results Summary
      shell: bash
      run: |
        echo "## ðŸ§ª Test Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.Test-Export.result }}" == "success" ]; then
          echo "âœ… **All platform exports successful!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "These builds are ready to release and will be kept for 30 days." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Ready to Release?" >> $GITHUB_STEP_SUMMARY
          echo "Go to: **Actions** â†’ **Release to GitHub & Itch.io** â†’ **Run workflow**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Some exports failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please fix the issues before releasing." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "Build artifacts available for 30 days (automatically used by releases)" >> $GITHUB_STEP_SUMMARY